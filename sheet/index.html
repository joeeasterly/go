<!DOCTYPE html>
<html>

<head>
  <title>Go: Data Retrieval Service</title>
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Roboto+Slab:wght@300;400&family=Roboto:wght@100;400&family=Source+Code+Pro&display=swap"
    rel="stylesheet">
  <script type="application/javascript" src="qrcode.js"></script>
  <script>
    // Extract "start" variable from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const startCode = urlParams.get('start');
    const firstLetter = startCode[0];
    const secondLetter = startCode[1];

    // Construct the file path
    const filePath = `../${firstLetter}/${secondLetter}/${firstLetter}${secondLetter}.json`;

    // Load the JSON file and process data
    fetch(filePath)
      .then(response => response.json())
      .then(data => {
        // Find the index of the object with the desired identifier
        const startIndex = data.findIndex(item => item.identifier === startCode);

        // Retrieve the desired object and the next 20 objects with allocated=false
        const desiredObjects = [];
        if (startIndex !== -1) {
          desiredObjects.push(data[startIndex]);
          for (let i = startIndex + 1; i < data.length && desiredObjects.length < 21; i++) {
            if (data[i].allocated === false) {
              desiredObjects.push(data[i]);
            }
          }
        }

        // Create and append div elements with spans for each field and QR code
        const container = document.createElement('div');
        container.className = 'container'; // Add a class to the container div

        desiredObjects.forEach((obj, index) => {
          const div = document.createElement('div');
          div.className = 'qrcode';
          const uniqueId = `qrcode-${index}`; // Generate a unique ID

          // Create QR code script
          const qrCodeScript = document.createElement('script');
          qrCodeScript.type = 'text/javascript';
          qrCodeScript.textContent = `
        var qrcode = new QRCode(document.getElementById("${uniqueId}"), {
          text: "${obj.target}", // Use the appropriate field from your data
          width: 128,
          height: 128,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      `;

          div.id = uniqueId; // Set the unique ID to the div
          div.appendChild(qrCodeScript); // Append the QR code script to the div

          for (const field in obj) {
            const span = document.createElement('span');
            span.className = field; // Use field name as CSS class
            span.textContent = obj[field];
            div.appendChild(span);
          }

          container.appendChild(div);
        });

        // Append the container to the body
        document.body.appendChild(container);
      })
      .catch(error => {
        console.error('Error loading JSON:', error);
      });
  </script>

  <style>
    .notion-logo {
      display: none;
    }

    ._id,
    .target,
    .class,
    .allocated {
      display: none;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .qrcode {
      width: 72pt;
      height: 72pt;
      border: 1pt dashed black;
    }

    .qrcode img {
      width: 60pt;
      margin: 6pt;
      margin-top:0;
    }

    .identifier {
      font-family: 'Source Code Pro', monospace;
      font-size: 8pt;
      text-align: center;
      display: block;
      background-color: white;
    }
  </style>
</head>

<body>
  <div id="qr-codes"></div>
</body>

</html>